extends layout

block title
  title SurgeTech | Settings

block content
  - const isAdminAccess = (user.role === 'admin' || (user.permissions && user.permissions.admin === true))
  .settings-container
    .tabsHeaderGroup
      h1 Settings

      // Tabs Navigation
      .tabs
        button.tab-link.active(data-tab='account') Account
        button.tab-link(data-tab='company-info') Company Info
        button.tab-link(data-tab='team') Team Members
        button.tab-link(data-tab='value-adds') Value Adds
        button#endTab.tab-link(data-tab='security') Security

    // Single Alert Container for All Tabs
    div#alert-container

    // Tab content container
    .tab-content
      // Account Tab Content
      .tab-panel#account.active
        .tabHeader
          //- p(style='color: red') Debug isAdminAccess (server-side): #{isAdminAccess}
          .tabHeaderText
            h2 Account Settings
            p.supportingText Edit your company account settings here.
          .form-actions
            button#account-cancel-button.btn.btn-secondary(type='button', disabled=true) Cancel
            button#account-save-button.btn.btn-primary(type='button', disabled=true) Save Changes

        hr.dividingLine

        // Basic Info Section
        .section
          form#account-form
            //- div.form-group.mb-3
            //-   label(for='account-name') Name
            //-   input.form-control#account-name(type='text', placeholder='Enter your name', value=user.name)

            div.form-group.mb-3
              label(for='account-first-name') First Name *
              input.form-control#account-first-name(
                type='text',
                placeholder='Enter your first name',
                value=user.firstName
              )

            div.form-group.mb-3
              label(for='account-last-name') Last Name *
              input.form-control#account-last-name(
                type='text',
                placeholder='Enter your last name',
                value=user.lastName
              )

            div.form-group.mb-3
              label(for='email-address') Email Address *
              input.form-control#email-address(type='email', placeholder='Enter email address', value=user.email)
            

            div.form-group.mb-3
              label(for='profile-avatar') Profile Avatar
              .profile-avatar-container
                .profile-avatar-image-container
                  img.uploaded-avatar-preview.hidden(src='')
                  if user.avatar
                    img.profile-avatar-preview(src=user.avatar, alt='User Avatar', class='profile-avatar-preview')
                  else
                    img.profile-avatar-preview(src='', alt='User Avatar', class='profile-avatar-preview')

                // Upload area
                .upload-box
                  span.upload-icon.material-symbols-outlined upload
                  label.custom-upload-button(for='profile-avatar') Upload
                  .upload-box-text
                    span.or-text.clickToUpload Click to upload
                    span.or-text or drag and drop PNG or JPG (Square images work best).

                // Hidden file input
                input#profile-avatar(type='file', hidden=true)

        hr.dividingLine

        .section
          h3 Change Password
          form#password-form
            div.form-group.mb-3
              label(for='old-password') Old Password
              input.form-control#old-password(type='password', placeholder='Enter old password')
            div.form-group.mb-3
              label(for='new-password') New Password
              input.form-control#new-password(type='password', placeholder='Enter new password')
            div.form-group.mb-3
              label(for='confirm-new-password') Confirm New Password
              input.form-control#confirm-new-password(type='password', placeholder='Confirm new password')

            .form-actions.updatePasswordButtons
              button#cancel-password-button.btn.btn-secondary(type='button', disabled=true) Cancel
              button#update-password-button.btn.btn-primary(type='submit', disabled=true) Update Password

      // Company Info Tab Content
      .tab-panel#company-info
        .tabHeader
          .tabHeaderText
            h2 Company Information
            p.supportingText View your company details here.
          .form-actions
            button#companyinfo-cancel-button.btn.btn-secondary(type='button', disabled=true) Cancel
            button#companyinfo-save-button.btn.btn-primary(type='button', disabled=true) Save Changes

        hr.dividingLine

        // Single Form for Company Info
        .section
          form#company-info-form
            // Section 1: Company Details
            div.form-group.mb-3
              label(for='company-info-name') Company Name *
              input.form-control#company-info-name(type='text', placeholder='Enter company name', value=user.companyName, disabled=(!isAdminAccess))
            
            div.form-group.mb-3
              label(for='company-id') Company ID *
              input.form-control#company-id(type='text', placeholder=user.companyId, value=user.companyId, disabled=true)

            

            div.form-group.mb-3
              label(for='company-info-website') Website URL
              input.form-control#company-info-website(type='url', placeholder='Enter website URL', value=user.companyWebsite, disabled=(!isAdminAccess))

            hr.dividingLine

            // Section 2: Company Logo
            div.form-group.mb-3
              label(for='company-logo') Company Logo
              .company-logo-wrapper
                // Fixed-size container for logo preview
                .logo-preview-container
                  img.company-logo-preview(src=user.companyLogo ? user.companyLogo : '', alt='Company Logo', class='company-logo-preview')

                // Upload area
                .upload-box
                  span.upload-icon.material-symbols-outlined upload
                  label.custom-upload-button(for='company-logo') Upload
                  .upload-box-text
                    span.or-text.clickToUpload Click to upload
                    span.or-text or drag and drop PNG or JPG (Any orientation).

                // Hidden file input
                input#company-logo(type='file', hidden=true)

            hr.dividingLine

            // Section 3: Company Address
            div.form-group.mb-3
              label(for='company-address') Address
              input.form-control#company-address(type='text', placeholder='Enter company address', value=user.companyAddress, disabled=(!isAdminAccess))

            //- hr.dividingLine

            // Section 4: Company Phone Number
            div.form-group.mb-3
              label(for='company-phone') Phone Number
              input.form-control#company-phone(type='text', placeholder='Enter phone number', value=user.phoneNumber, disabled=(!isAdminAccess))

      .tab-panel#value-adds
        .tabHeader
          .tabHeaderText
            h2 Value Adds
            p.supportingText Manage firm-wide Value Add configurations.
          .form-actions
            button#valueadds-cancel-button.btn.btn-secondary(type='button', disabled=true) Cancel
            button#valueadds-save-button.btn.btn-primary(type='button', disabled=true) Save Changes

        hr.dividingLine

        // Buckets Value Add Card Container
        .valueAddCard#bucketsCard
          .valueAddCardHeader
            .header-top
              // Left side: Icon + "Buckets" label
              .valueAddCardTitle
                i.material-symbols-outlined.settings-value-add-icon analytics
                .header-text-subText
                  span.cardTitleText Buckets
                  .valueAddCardSubText The Buckets Value Add breaks a household’s investment portfolio into “buckets” (e.g., Cash, Income, Growth), each serving a specific goal, from immediate liquidity to long-term growth. With dynamic calculations of distribution rates, income potential, and rebalancing thresholds, it provides a clear, goal-based framework to visualize assets and discuss short-term needs and long-term sustainability.

              // Right side: Toggle switch (no label)
              .valueAddToggle
                label.switch
                  input#buckets-enabled(type='checkbox', checked=(bucketsEnabled ? true : undefined))
                  span.slider.round

            // Expand/Collapse arrow or button
            button#bucketsExpandBtn.btn.btn-sm.btn-outline-secondary(type='button')
              i.material-symbols-outlined arrow_drop_down
              | Show Settings

          // Expandable content (hidden by default)
          .valueAddCardBody#bucketsSettingsPanel(style='display: none;')
            .mb-3
              label.form-label(for='buckets-title') Buckets Title
              input.form-control#buckets-title(
                type='text',
                placeholder='Buckets Strategy',
                value=bucketsTitle
              )

            .mb-3
              label.form-label(for='buckets-disclaimer') Buckets Disclaimer
              textarea.form-control#buckets-disclaimer(
                rows='4'
              )= bucketsDisclaimer


      // Security Tab Content
      .tab-panel#security
        .tabHeader
          .tabHeaderText
            h2 Security Settings
            p.supportingText Manage your security preferences here.
          .form-actions
            button#security-cancel-button.btn.btn-secondary(type='button', disabled=true) Cancel
            button#security-save-button.btn.btn-primary(type='button', disabled=true) Save Changes

        hr.dividingLine

        // 2FA Section
        .section(data-2fa-enabled=user.is2FAEnabled)
          h3 Two-Factor Authentication (2FA)
          p#twofa-status-text= user.is2FAEnabled ? '2FA is currently enabled on your account.' : '2FA is currently disabled on your account.'

          // Conditionally Render Enable or Disable 2FA Button
          if user.is2FAEnabled
            button#disable2FA-button.btn.btn-danger(type='button') Disable 2FA
          else
            button#enable-2fa-button.btn.btn-primary(type='button') Enable 2FA

          // 2FA Setup Modal

          // 2FA Setup Modal
          div#twofa-modal.modal.fade(tabindex='-1', aria-labelledby='twofaModalLabel', aria-hidden='true')
            div.modal-dialog.modal-dialog-centered
              div.modal-content
                div.modal-header
                  i.lock-icon.material-symbols-outlined lock
                  h5.modal-title#twofaModalLabel Set up two-factor authentication
                  button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')

                div.modal-body
                  p.modal-subtitle#twofaModalSubtitle 2FA is a fantastic way to improve your account security. Use an authenticator app on your mobile device to scan this QR code and enter the verification code below.
                  img#qr-code.img-fluid(src='', alt='QR Code for 2FA') 

                  // Verification Code Input Section
                  div.verification-code
                    input.form-control.code-segment(type='text', maxlength='1', id='code-segment-1')
                    input.form-control.code-segment(type='text', maxlength='1', id='code-segment-2')
                    input.form-control.code-segment(type='text', maxlength='1', id='code-segment-3')
                    span.hyphen - 
                    input.form-control.code-segment(type='text', maxlength='1', id='code-segment-4')
                    input.form-control.code-segment(type='text', maxlength='1', id='code-segment-5')
                    input.form-control.code-segment(type='text', maxlength='1', id='code-segment-6')

                div.modal-footer
                  button#cancel2fa-button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
                  button#verify2FA-button.btn.btn-primary(type='button') Confirm
      


        hr.dividingLine

      
        .section
          h3 Last 10 Sign-In Activities
          table.signin-logs-table
            thead
              tr
                th Timestamp
                th Location
                th Device
            tbody#signin-logs-body
              //- Rows will be populated by JavaScript
      
      
      .tab-panel#team(data-company-id=user.companyId data-firm-id=user.firmId data-is-admin=isAdminAccess)
        .tabHeader
          .tabHeaderText
            h2 Team Members
            p.supportingText View and manage your firm's team members.
            //- p.userRoleTag #{user.role}


          .form-actions
            if isAdminAccess
              button#add-team-member-button.btn.btn-primary(type='button') Add Team Member

        hr.dividingLine

 
        .section
          .team-members-table-container
            table.team-members-table.table.table-striped.table-hover
              thead
                tr
                  th.tableHead1.avatar-head 
                  th.tableHead1.email-head Email
                  th.tableHead1.role-head Role
                  th.tableHead1.permissions-head Permissions
                  th.tableHead1.status-head Status
                  th.actions-head Actions
                    
              tbody#team-members-body
                // Rows will be inserted dynamically via teams.js

  // At bottom of your Pug or near the Add Team Member modal
  div#edit-team-member-modal.modal.fade(tabindex='-1', aria-labelledby='editTeamMemberModalLabel', aria-hidden='true')
    div.modal-dialog.modal-dialog-centered
      div.modal-content
        div.modal-header
          h5.modal-title#editTeamMemberModalLabel Edit Team Member
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        div.modal-body
          form#edit-team-member-form
            input(type='hidden' id='edit-user-id')
            div.form-group.mb-3
              label(for='edit-role') Role
              select#edit-role.form-select(name='role')
                option(value='admin') Admin
                option(value='advisor') Advisor
                option(value='assistant') Assistant

            div.form-group.mb-3#editAlsoAdvisorContainer(style='display: none;')
              input#editAlsoAdvisorCheckbox(type='checkbox', name='editAlsoAdvisor')
              label(for='editAlsoAdvisorCheckbox') Also an advisor?

            // For Permissions, we can do checkboxes or text-based JSON input:
            div.form-group.mb-3
              label(for='edit-permissions') Permissions *
              select#edit-permissions.form-select(name='role')
                option(value='admin') Admin
                option(value='advisor') Advisor
                option(value='assistant') Assistant
             

        div.modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button#edit-submit.btn.btn-primary(type='submit' form='edit-team-member-form') Save Changes



  if isAdminAccess
    div#add-team-member-modal.modal.fade(tabindex='-1', aria-labelledby='addTeamMemberModalLabel', aria-hidden='true')
      div.modal-dialog.modal-dialog-centered
        div.modal-content
          div.modal-header
            h5.modal-title#addTeamMemberModalLabel Invite a New Team Member
            button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
          div.modal-body
            form#add-team-member-form
              div.form-group.mb-3
                label(for='invite-email') Email Address *
                input#invite-email.form-control(type='email', required=true, placeholder='Enter the email address')

              div.form-group.mb-3
                label(for='invite-role') Role *
                select#invite-role.form-select(name='role', required=true)
                  option(value='advisor') Advisor
                  option(value='assistant') Assistant
                  option(value='admin') Admin

              div.form-group.mb-3#also-advisor-container(style='display: none;')
                input#also-advisor-checkbox(type='checkbox', name='alsoAdvisor')
                label(for='also-advisor-checkbox') Also an advisor?

            
              div.form-group.mb-3
                label(for='invite-permissions') Permissions * 
                select#invite-permissions.form-select(name='permissions', required=true)
                  option(value='advisor') Advisor
                  option(value='assistant') Assistant
                  option(value='admin') Admin
  

          div.modal-footer
            button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
            button#invite-submit.btn.btn-primary(type='submit', form='add-team-member-form') Invite

  // Confirmation Modal for Removing a Team Member
  div#confirmRemoveModal.modal.fade(tabindex='-1' aria-hidden='true')
    div.modal-dialog.modal-dialog-centered
      div.modal-content
        div.modal-header
          h5.modal-title Confirm Removal
          button.btn-close(type='button' data-bs-dismiss='modal' aria-label='Close')
        div.modal-body
          // We'll dynamically insert the email or message via JS
          p#confirmRemoveMessage Are you sure you want to remove this member?
        div.modal-footer
          button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Cancel
          button#confirmRemoveBtn.btn.btn-danger(type='button') Remove


block scripts
  script.
    window.IS_ADMIN_ACCESS = !{isAdminAccess};
  script(src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js', integrity='sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz', crossorigin='anonymous')
  script(src='/js/appScript.js')
  script(src='/js/settings.js')
  script(src='/js/teams.js')
  script(src='/js/headerDropdownFilter.js')
  script(src="/js/loading.js")
