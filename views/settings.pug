extends layout

block title
  title Settings | SurgeTk

block content
  - const isAdminAccess = (user.role === 'admin' || (user.permissions && user.permissions.admin === true))
 
  .settings-container
    div#subscription-status-alert
      // This will be toggled in JS
      //- .alert2(role="alert") 
      //-   span#subscription-status-message 
    .tabsHeaderGroup
      h1 Settings

      // Tabs Navigation
      .tabs
        button#leftEndTab.tab-link(data-tab='account' data-route='account').active My Profile
        button.tab-link(data-tab='company-info' data-route='company-info') Firm Info
        button.tab-link(data-tab='team' data-route='team') Team Members
        button.tab-link(data-tab='value-adds' data-route='firm-value-adds') Value Adds
        button.tab-link(data-tab='billing' data-route='firm-billing') Billing
        button#endTab.tab-link(data-tab='security' data-route='security') My Security

    // Single Alert Container for All Tabs
    div#alert-container


    .tab-content
      .tab-panel#account.active
        .tabHeader
          //- p(style='color: red') Debug isAdminAccess (server-side): #{isAdminAccess}
          .tabHeaderText
            h2 My Profile Settings
            p.supportingText Edit your profile settings here.
          .form-actions
            button#account-cancel-button.btn.btn-secondary(type='button', disabled=true) Cancel
            button#account-save-button.btn.btn-primary(type='button', disabled=true) Save Changes

        hr.dividingLine

        // Basic Info Section
        .section
          form#account-form


            div.form-group.mb-3
              label(for='account-first-name') First Name *
              input.form-control#account-first-name(
                type='text',
                placeholder='Enter your first name',
                value=user.firstName
              )

            div.form-group.mb-3
              label(for='account-last-name') Last Name *
              input.form-control#account-last-name(
                type='text',
                placeholder='Enter your last name',
                value=user.lastName
              )

            div.form-group.mb-3
              label(for='email-address') Email Address *
              input.form-control#email-address(type='email', placeholder='Enter email address', value=user.email, readonly disabled)
            

            div.form-group.mb-3
              label(for='profile-avatar') Profile Avatar
              .profile-avatar-container
                .profile-avatar-image-container
                  img.uploaded-avatar-preview.hidden(src='')
                  if user.avatar
                    img.profile-avatar-preview(src=user.avatar, alt='User Avatar', class='profile-avatar-preview')
                  else
                    img.profile-avatar-preview(src='', alt='User Avatar', class='profile-avatar-preview')

                // Upload area
                .upload-box
                  span.upload-icon.material-symbols-outlined upload
                  label.custom-upload-button(for='profile-avatar') Upload
                  .upload-box-text
                    span.or-text.clickToUpload Click to upload
                    span.or-text or drag and drop PNG or JPG (Square images work best).

                // Hidden file input
                input#profile-avatar(type='file', hidden=true)

        hr.dividingLine

        .section
          h3 Change Password
          form#password-form
            div.form-group.mb-3
              label(for='old-password') Old Password
              input.form-control#old-password(type='password', placeholder='Enter old password')
            div.form-group.mb-3
              label(for='new-password') New Password
              input.form-control#new-password(type='password', placeholder='Enter new password')
            div.form-group.mb-3
              label(for='confirm-new-password') Confirm New Password
              input.form-control#confirm-new-password(type='password', placeholder='Confirm new password')

            .form-actions.updatePasswordButtons
              button#cancel-password-button.btn.btn-secondary(type='button', disabled=true) Cancel
              button#update-password-button.btn.btn-primary(type='submit', disabled=true) Update Password

      // Company Info Tab Content
      .tab-panel#company-info
        .tabHeader
          .tabHeaderText
            h2 Firm Information
            p.supportingText View and edit your firm details here.
          .form-actions
            button#companyinfo-cancel-button.btn.btn-secondary(type='button', disabled=true) Cancel
            button#companyinfo-save-button.btn.btn-primary(type='button', disabled=true) Save Changes

        hr.dividingLine



        // Single Form for Company Info
        .section

            // Section 2: Company Logo
            div.form-group.mb-3
              label(for='company-logo') Firm Logo
              .company-logo-wrapper
                // Fixed-size container for logo preview
                .logo-preview-container#companyLogoPreviewContainer
                  // If user.companyLogo exists, display it
                  if user.companyLogo
                    img#companyLogoPreview.company-logo-preview(
                      src=user.companyLogo
                      alt='Company Logo'
                      class='company-logo-preview'
                    )
                  else
                    // Otherwise, display a placeholder image
                    img#companyLogoPreview.company-logo-preview.company-logo-preview-placeholder(
                      src='/images/placeholder-logo.png' 
                      alt='No Logo'
                      class='company-logo-preview'
                    )

                // Upload area
                if isAdminAccess
                  .upload-box
                    span.upload-icon.material-symbols-outlined upload
                    label.custom-upload-button(for='company-logo') Upload
                    .upload-box-text
                      span.or-text.clickToUpload Click to upload
                      span.or-text or drag and drop PNG or JPG (Any orientation).

                // Hidden file input
                input#company-logo(type='file', hidden=true, disabled=(!isAdminAccess))

            // branding color
            div.form-group.mb-3
              label(for='company-branding-color') Firm Branding Color
              // Conditionally add a "color-picker-disabled" class if user is not admin
              #color-picker-container(class=(!isAdminAccess ? 'color-picker-disabled' : ''))
                input#company-branding-color.form-control(
                  type='text',
                  name='companyBrandingColor',
                  value=(user.companyBrandingColor || ''),
                  placeholder='#FFFFFF',
                  style='display:none;'
                )


            hr.dividingLine

        
            form#company-info-form
              // Section 1: Company Details
              div.form-group.mb-3
                label(for='company-id') Firm ID *
                input.form-control#company-id(type='text', placeholder=user.companyId, value=user.companyId, disabled=true)
              div.form-group.mb-3
                label(for='company-info-name') Firm Name *
                input.form-control#company-info-name(type='text', placeholder='Enter company name', value=user.companyName, disabled=(!isAdminAccess))
              

  
              
  
              div.form-group.mb-3
                label(for='company-info-website') Firm Website URL
                input.form-control#company-info-website(type='text', placeholder='Enter website URL', value=user.companyWebsite, disabled=(!isAdminAccess))
  
              hr.dividingLine
  
  
  
              // Section 3: Company Address
              div.form-group.mb-3
                label(for='company-address') Address
                input.form-control#company-address(type='text', placeholder='Enter company address', value=user.companyAddress, disabled=(!isAdminAccess))
  
              //- hr.dividingLine
  
              // Section 4: Company Phone Number
              div.form-group.mb-3
                label(for='company-phone') Phone Number
                input.form-control#company-phone(type='text', placeholder='Enter phone number', value=user.phoneNumber, disabled=(!isAdminAccess))


              hr.dividingLine
              div.form-group.mb-3
                label(for='custodianDisplayInput') Custodian(s) Used
                .dropdown#custodianDropdownSettings
                  .select-container
                    span.material-symbols-outlined keyboard_arrow_down
                    // 1) Visible read-only text input that triggers the dropdown
                    input.form-control(
                      type='text'
                      id='custodianDisplayInputSettings'
                      placeholder='Select Custodian(s)'
                      data-bs-toggle='dropdown'
                      aria-expanded='false'
                      readonly
                      style='cursor: pointer;'
                    )
                    // 2) Hidden input that gets submitted to server
                    input(type='hidden', name='custodian', id='custodianHiddenInputSettings')
                    // 3) Dropdown with checkboxes
                    .dropdown-menu
                      label.dropdown-item.form-check-label
                        input.form-check-input(type='checkbox' class='custodianCheckboxSettings' value='Fidelity')
                        | Fidelity
                      label.dropdown-item.form-check-label
                        input.form-check-input(type='checkbox' class='custodianCheckboxSettings' value='Charles Schwab')
                        | Charles Schwab

                      label.dropdown-item.form-check-label
                        input.form-check-input(type='checkbox' class='custodianCheckboxSettings' value='Vanguard')
                        | Vanguard
                      label.dropdown-item.form-check-label
                        input.form-check-input(type='checkbox' class='custodianCheckboxSettings' value='Pershing')
                        | Pershing
                      label.dropdown-item.form-check-label
                        input.form-check-input(type='checkbox' class='custodianCheckboxSettings' value='Raymond James')
                        | Raymond James
                      label.dropdown-item.form-check-label
                        input.form-check-input(type='checkbox' class='custodianCheckboxSettings' value='LPL Financial')
                        | LPL Financial
                      label.dropdown-item.form-check-label
                        input.form-check-input(type='checkbox' class='custodianCheckboxSettings' value='E-Trade')
                        | E-Trade
                      label.dropdown-item.form-check-label
                        input.form-check-input(type='checkbox' class='custodianCheckboxSettings' value='Merrill Lynch')
                        | Merrill Lynch
                      hr.dropdown-divider
                      // "Other" checkbox
                      label.dropdown-item.form-check-label
                        input.form-check-input(
                          type='checkbox' 
                          class='custodianCheckboxSettings' 
                          value='Other' 
                          id='custodianOtherCheckboxSettings'
                        )
                        | Other
                      input.form-control.mt-2#otherCustodianInputSettings(
                        type='text'
                        placeholder='Type other custodian'
                        style='display: none;'
                      )

              // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
              // (2) Broker Dealer yes/no
              // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
              div.form-group.mb-3
                label(for='brokerDealerSelectSettings') Is this firm a Broker Dealer?
                .select-container
                  span.material-symbols-outlined keyboard_arrow_down
                  select.form-select#brokerDealerSelectSettings(name='brokerDealer')
                    option(value='' disabled selected=(!user || user.brokerDealer === undefined)) --
                    option(value='yes' selected=(user && user.brokerDealer === true)) Yes
                    option(value='no' selected=(user && user.brokerDealer === false)) No

              // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
              // (3) RIA yes/no
              // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
              div.form-group.mb-3
                label(for='riaSelectSettings') Is this firm an RIA?
                .select-container
                  span.material-symbols-outlined keyboard_arrow_down
                  select.form-select#riaSelectSettings(name='isRIA')
                    option(value='' disabled selected=(!user || user.isRIA === undefined)) --
                    option(value='yes' selected=(user && user.isRIA === true)) Yes
                    option(value='no' selected=(user && user.isRIA === false)) No

      .tab-panel#value-adds
        .tabHeader
          .tabHeaderText
            h2 Value Adds
            p.supportingText Manage firm-wide Value Add configurations.
          .form-actions
            button#valueadds-cancel-button.btn.btn-secondary(type='button', disabled=true) Cancel
            button#valueadds-save-button.btn.btn-primary(type='button', disabled=true) Save Changes

        hr.dividingLine

        .mb-3
          form-label-head
            label.form-label(for='buckets-distribution-rate') Available Distribution Rate (%)
            p.supportingText2 This is the rate that applies to both the Guardrails and Buckets Value Adds. This rate is the 'available' distrbuton rate for a household to take based on their total financial asset portfolio value.
          input.form-control.short-form#buckets-distribution-rate(type='number', step='0.001', min='0', value=bucketsDistributionRate * 100)

        // Buckets Value Add Card Container
        .valueAddCard#bucketsCard
          .valueAddCardHeader
            .header-top
              // Left side: Icon + "Buckets" label
              .valueAddCardTitle
                i.material-symbols-outlined.settings-value-add-icon analytics
                .header-text-subText
                  span.cardTitleText Buckets
                  .valueAddCardSubText The Buckets Value Add breaks a household’s investment portfolio into “buckets” (e.g., Cash, Income, Growth), each serving a specific goal, from immediate liquidity to long-term growth. With dynamic calculations of distribution rates, income potential, and rebalancing thresholds, it provides a clear, goal-based framework to visualize assets and discuss short-term needs and long-term sustainability.

              // Right side: Toggle switch (no label)
              .valueAddToggle
                label.switch
                  input#buckets-enabled(type='checkbox', checked=(bucketsEnabled ? true : undefined))
                  span.slider.round

            // Expand/Collapse arrow or button
            button#bucketsExpandBtn.btn.btn-sm.btn-outline-secondary(type='button')
              i.material-symbols-outlined arrow_drop_down
              | Show Settings

          // Expandable content (hidden by default)
          .valueAddCardBody#bucketsSettingsPanel(style='display: none;')
            .mb-3
              label.form-label(for='buckets-title') Buckets Title
              input.form-control#buckets-title(
                type='text',
                placeholder='Buckets Strategy',
                value=bucketsTitle
              )

            .mb-3
              label.form-label(for='buckets-disclaimer') Buckets Disclaimer
              textarea.form-control#buckets-disclaimer(
                rows='4'
              )= bucketsDisclaimer
            //- .mb-3
              //- label.form-label(for='buckets-distribution-rate') Buckets Distribution Rate (%)
              //- input.form-control.short-form#buckets-distribution-rate(type='number', step='0.001', min='0', value=bucketsDistributionRate * 100)




        .valueAddCard#guardrailsCard
          .valueAddCardHeader
            .header-top
              // Left side: Icon + "Guardrails" label
              .valueAddCardTitle
                i.material-symbols-outlined.settings-value-add-icon add_road
                .header-text-subText
                  span.cardTitleText Guardrails
                  .valueAddCardSubText The Guardrails Value Add helps illustrate safe withdrawal boundaries, adjusting distributions over time based on portfolio performance to help sustain retirement income goals
              // Right side: Toggle switch
              .valueAddToggle
                label.switch
                  input#guardrails-enabled(type='checkbox')
                  span.slider.round
            // Expand/Collapse arrow
            button#guardrailsExpandBtn.btn.btn-sm.btn-outline-secondary(type='button')
              i.material-symbols-outlined arrow_drop_down
              | Show Setting
          // Expandable content (hidden by default)
          .valueAddCardBody#guardrailsSettingsPanel(style='display: none;')
            .mb-3
              label.form-label(for='guardrails-title') Guardrails Title
              input.form-control#guardrails-title(
                type='text',
                placeholder='Guardrails Strategy')

            .mb-3
              label.form-label(for='guardrails-disclaimer') Guardrails Disclaimer
              textarea.form-control#guardrails-disclaimer(rows='4')

        // ======================
        //  Beneficiary Value Add
        // ======================
        .valueAddCard#beneficiaryCard
          .valueAddCardHeader
            .header-top
              // Left side: Icon + "Beneficiary" label
              .valueAddCardTitle
                i.material-symbols-outlined.settings-value-add-icon diversity_1
                .header-text-subText
                  span.cardTitleText Beneficiary
                  .valueAddCardSubText
                    | The Beneficiary Value Add rolls up beneficiary data across accounts, enabling quick review of primary and contingent splits. It ensures each household’s designated beneficiaries match the client’s legacy goals, highlighting any incomplete or missing beneficiary information.
      
              // Right side: Toggle switch
              .valueAddToggle
                label.switch
                  input#beneficiary-enabled(type='checkbox', checked=(beneficiaryEnabled ? true : undefined))
                  span.slider.round
      
            // Expand/Collapse arrow
            button#beneficiaryExpandBtn.btn.btn-sm.btn-outline-secondary(type='button')
              i.material-symbols-outlined arrow_drop_down
              | Show Settings
      
          // Expandable content (hidden by default)
          .valueAddCardBody#beneficiarySettingsPanel(style='display: none;')
            .mb-3
              label.form-label(for='beneficiary-title') Beneficiary Title
              input.form-control#beneficiary-title(
                type='text',
                placeholder='Beneficiary Value Add',
                value=beneficiaryTitle
              )
            .mb-3
              label.form-label(for='beneficiary-disclaimer') Beneficiary Disclaimer
              textarea.form-control#beneficiary-disclaimer(rows='4')= beneficiaryDisclaimer
      
        // ------------------------
        // Net Worth Value Add card
        // ------------------------
        .valueAddCard#networthCard
          .valueAddCardHeader
            .header-top
              // Left side: icon + label
              .valueAddCardTitle
                i.material-symbols-outlined.settings-value-add-icon account_balance
                .header-text-subText
                  span.cardTitleText Net Worth
                  .valueAddCardSubText The Net Worth Value Add calculates a household’s total assets minus liabilities, presenting an overall net worth figure. It includes dynamic ownership columns for each spouse, showcasing how assets and liabilities are distributed.
      
              // Right side: Toggle switch
              .valueAddToggle
                label.switch
                  // When checked => networth is enabled
                  input#networth-enabled(type='checkbox')
                  span.slider.round
      
            // Expand/Collapse button
            button#networthExpandBtn.btn.btn-sm.btn-outline-secondary(type='button')
              i.material-symbols-outlined arrow_drop_down
              | Show Settings
      
          // The panel that slides open on expand
          .valueAddCardBody#networthSettingsPanel(style='display: none;')
            .mb-3
              label.form-label(for='networth-title') Net Worth Title
              input.form-control#networth-title(
                type='text',
                placeholder='Net Worth Report'
              )
      
            .mb-3
              label.form-label(for='networth-disclaimer') Net Worth Disclaimer
              textarea.form-control#networth-disclaimer(rows='4')
      






      .tab-panel#billing
        - // Simple check to see if subscriptionStatus indicates "annual"
        - // Adjust logic as needed if you store it differently.
        - const isAnnual = subscriptionStatus && subscriptionStatus.toLowerCase().includes('annual');

        .tabHeader
          .tabHeaderText
            h2 Billing
   
            p.supportingText Manage your subscription and payment details.
          .form-actions
            button#security-cancel-button.btn.btn-secondary(type='button', disabled=true) Cancel
            button#security-save-button.btn.btn-primary(type='button', disabled=true) Save Changes

        hr.dividingLine
        if showSubAlert
          if subAlertType === 'canceled'
            .alert.alert-danger.status-alert
              strong Canceled Subscription: 
              | Your firm’s subscription is canceled. Please update your payment method or choose a new plan below.
          else if subAlertType === 'past_due'
            .alert.alert-warning.status-alert
              strong Past Due:
              | Your firm’s subscription is past due. Please update your payment method to avoid cancellation.

        if cancelAtPeriodEnd
          .alert.alert-warning#cancellation-banner(style='display:none;')
            | Your plan is set to cancel at the end of this billing period.
        else
          .alert.alert-warning#cancellation-banner(style='display:none;')


 

        .section#pricing-plans
          .row.pricing-rows
            // FREE CARD
            .col-md-4
              // Highlight if subscriptionTier === 'free'
              .card.pricing-card(class=(subscriptionTier === 'free' ? 'current-plan' : ''))
                .card-header
                  p.card-head-plan Free
                  .price-container 
                    p.price-text $0

                .card-body
                  if subscriptionTier === 'free'
                    .big-check
                      i.fas.fa-check-circle.me-2.text-success.big-check-icon
                    button.btn.btn-secondary.disabled.current-plan
                      i.fas.fa-check-circle.me-2.current-plan-check
                      p.current-plan-text Current Plan
                  else
                    button#downgrade-free-button.btn.btn-outline-primary(data-plan='free' type='button') Downgrade
                  .pricing-card-description
                    p.descriptive-text Basic features
                    ul
                      //- li
                      //-   i.fas.fa-check-circle.me-2.text-success 
                      //-   | 1 Advisor
                      //- li
                      //-   i.fas.fa-check-circle.me-2.text-success 
                      //-   | 2 Non-Advisors
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | 2 Value Adds
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | Basic Features

            // PRO CARD
            .col-md-4
              // Highlight if subscriptionTier === 'pro'
              .card.pricing-card(class=(subscriptionTier === 'pro' ? 'current-plan' : ''))
                .card-header
                  p.card-head-plan Pro
                  .price-container
                    p#pro-price-text.price-text $95
                    p#pro-price-frequency /seat per month
                .card-body
                  if subscriptionTier === 'pro'
                    .big-check
                      i.fas.fa-check-circle.me-2.text-success.big-check-icon
                    button.btn.btn-secondary.disabled.current-plan
                      i.fas.fa-check-circle.me-2.current-plan-check
                      p.current-plan-text Current Plan
                  else
                    button#upgrade-pro-button.btn.btn-outline-primary(data-plan='pro' type='button') Upgrade
                  .pricing-card-description
                    p.descriptive-text Ideal for professionals
                    ul
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | SurgeTK Account Manager
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | Full Value-Adds Library
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | Access to Surge
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | Advisor Packets
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | Unlimited Value-Adds
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | Priority Support
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | All Advanced Features
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | 2-Factor Authentication
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | User Change Logs
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | Submit Feature Requests

            // ENTERPRISE CARD
            .col-md-4
              // Highlight if subscriptionTier === 'enterprise'
              .card.pricing-card(class=(subscriptionTier === 'enterprise' ? 'current-plan' : ''))
                .card-header
                  p.card-head-plan Enterprise
                  .price-container
                    p.enterprise-price-text Contact for pricing
                .card-body

                  if subscriptionTier === 'enterprise'
                    .big-check
                      i.fas.fa-check-circle.me-2.text-success.big-check-icon
                    button.btn.btn-secondary.disabled.current-plan
                      i.fas.fa-check-circle.me-2.current-plan-check
                      p.current-plan-text Current Plan
                  else
                    button.btn.btn-outline-primary(data-plan='enterprise' type='button') Contact Us
                  .pricing-card-description
                    p.descriptive-text For larger firms with advanced needs
                    ul
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | All Pro features
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | Custom Integrations
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | Custom Features
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | White Glove Support
                      li
                        i.fas.fa-check-circle.me-2.text-success 
                        | Special Pricing


        hr.dividingLine

        // Current Subscription Info
        
        section#current-plan-section


          table.billing-table
            thead
              tr
                th Current Plan
                th Seats
                th Billing Frequency
                th Billing Total
                th.nbd Next Billing Date
            tbody
              tr
                td#current-plan-text Free
                td#current-seats-purchased 0
                td#current-billing-frequency N/A
                td#current-billing-total N/A
                td#current-next-bill.nbd N/A




          .plan-action-buttons
            button#change-plan-button.btn.btn-primary.mainButton(type='button') Upgrade / Change Plan
            if subscriptionTier === 'pro' && !cancelAtPeriodEnd
              button#explicit-cancel-button.btn.btn-danger.mainButton(type='button')
                | Cancel Subscription



        hr.dividingLine

        // Payment Method Section
        .section#payment-method-section
          h4.tabHeaderText Payment Method
          p
            | Currently on file: 
            span#payment-method-brand No card
          
            span#payment-method-last4 
          button#update-card-button.btn.btn-secondary.mainButton(type='button') Update Billing Info

        hr.dividingLine

      div#unsavedChangesModal.modal.fade(tabindex='-1' aria-labelledby='unsavedChangesModalLabel' aria-hidden='true')
        div.modal-dialog
          div.modal-content
            div.modal-header
              h5.modal-title#unsavedChangesModalLabel Unsaved Changes
              button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
            div.modal-body
              p You have unsaved changes. If you leave now, those changes will be lost. 
                | Are you sure you want to continue?
            div.modal-footer
              button.btn.btn-secondary(type='button', data-bs-dismiss='modal' id='stay-here-btn') Cancel
              button.btn.btn-primary(type='button', id='discard-changes-btn') Leave Without Saving
      




      // ------------------------------------------------
      // CANCEL SUBSCRIPTION MODAL (Multi-Step Wizard)
      // ------------------------------------------------
      div#cancelSubscriptionModal.modal.fade(tabindex='-1' aria-hidden='true')
        .modal-dialog.modal-lg.modal-dialog-centered
          .modal-content

            // Modal Header
            .modal-header
              h5.modal-title Cancel Your Subscription
              button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')

            // MODAL BODY (step content only — no nav buttons here)
            .modal-body.py-3

              // ~~~~~~~~~~~~~~~ STEP 1 ~~~~~~~~~~~~~~~~~~
              div#cancel-wizard-step-1.cancellation-step(style='display:none;')

                p.step-text
                  | Are you sure you want to cancel? You will lose all Pro features of SurgeTK.

                .card-body
                  // Heading
                  h5.mb-3.billing-options-text Pro Access Plan

                  // Two-column list of features
                  .row.feature-row
                    .col-md-6
                      ul.list-unstyled
                        li.d-flex.align-items-center.mb-2
                          i.fas.fa-check.text-success.me-2
                          span SurgeTK Account Manager
                        li.d-flex.align-items-center.mb-2
                          i.fas.fa-check.text-success.me-2
                          span Full Value-Add Library
                        li.d-flex.align-items-center.mb-2
                          i.fas.fa-check.text-success.me-2
                          span Unlimited Value-Add Generation
                        li.d-flex.align-items-center.mb-2
                          i.fas.fa-check.text-success.me-2
                          span Advisor Packet Customization
                        li.d-flex.align-items-center
                          i.fas.fa-check.text-success.me-2
                          span Unlimited Surges

                    .col-md-6
                      ul.list-unstyled
                        li.d-flex.align-items-center.mb-2
                          i.fas.fa-check.text-success.me-2
                          span Priority Customer Support / Setup
                        li.d-flex.align-items-center.mb-2
                          i.fas.fa-check.text-success.me-2
                          span Early Access to New Value-Adds
                        li.d-flex.align-items-center.mb-2
                          i.fas.fa-check.text-success.me-2
                          span View Data By Advisor: Aum, Billing Income
                        li.d-flex.align-items-center.mb-2
                          i.fas.fa-check.text-success.me-2
                          span User Level Data Loggs / Signins
                        li.d-flex.align-items-center
                          i.fas.fa-check.text-success.me-2
                          span 2 factor authentication

              // ~~~~~~~~~~~~~~~ STEP 2 ~~~~~~~~~~~~~~~~~~
              div#cancel-wizard-step-2.cancellation-step(style='display:none;')
                h3.mb-3 Let us know your reason(s) for canceling:

                // Grid or list of reasons with icons & checkboxes
                div.cancel-reasons-grid
                  label.reason-option(for='reason1')
                    input#reason1.form-check-input.cancel-reason(type='checkbox' value='Not using it enough')
                    i.fas.fa-user-clock.reason-icon
                    span.reason-text Not using it enough

                  label.reason-option(for='reason2')
                    input#reason2.form-check-input.cancel-reason(type='checkbox' value='Not seeing value')
                    i.fas.fa-eye-slash.reason-icon
                    span.reason-text Not seeing value

                  label.reason-option(for='reason3')
                    input#reason3.form-check-input.cancel-reason(type='checkbox' value='Too expensive')
                    i.fas.fa-dollar-sign.reason-icon
                    span.reason-text Too expensive

                  label.reason-option(for='reason4')
                    input#reason4.form-check-input.cancel-reason(type='checkbox' value='Found alternative to SurgeTK')
                    i.fas.fa-exchange-alt.reason-icon
                    span.reason-text Found alternative to SurgeTK

                  label.reason-option(for='reason5')
                    input#reason5.form-check-input.cancel-reason(type='checkbox' value='Too hard to use')
                    i.fas.fa-tools.reason-icon
                    span.reason-text Too hard to use



                  label.reason-option(for='reason7')
                    input#reason7.form-check-input.cancel-reason(type='checkbox' value='Technical issues')
                    i.fas.fa-bug.reason-icon
                    span.reason-text Technical issues

              // ~~~~~~~~~~~~~~~ STEP 3 ~~~~~~~~~~~~~~~~~~
              // ~~~~~~~~~~~~~~~ STEP 3 ~~~~~~~~~~~~~~~~~~
              div#cancel-wizard-step-3.cancellation-step(style='display:none;')
                // Heading
                h3.mb-3 We may have a Solution for you.

                // Card Container
                .solution-offer-card.p-3(
                  style='background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 6px;'
                )
                  // Icon + Intro text
                  .d-flex.align-items-start.mb-3.icon-intro-text
                    // Icon (phone or similar)
                    i.fas.fa-phone-volume.text-success(
                      style='font-size: 2rem; margin-right: 1rem;'
                    )
                    // Headline & sub-text
                    .solution-intro
                      p.mb-0.solution-head-text
                        | We would like to offer you a 
                        strong.call-text-3 Complementary 1:1 Strategy Call,
                        | We want to invest in you getting the most out of SurgeTK

                  // Two columns of bullet points (optional)
                  .row.lis-rows
                    .col-md-6
                      ul.list-unstyled
                        li.mb-1
                          i.fas.fa-circle.list-bullet.me-2(style='font-size: 0.5rem; color: #333;')
                          | Leverage SurgeTK Features
                        li.mb-1
                          i.fas.fa-circle.list-bullet.me-2(style='font-size: 0.5rem; color: #333;')
                          | Guided Onboarding
                        li.mb-1
                          i.fas.fa-circle.list-bullet.me-2(style='font-size: 0.5rem; color: #333;')
                          | Done for you imports / setup

                    .col-md-6
                      ul.list-unstyled
                        li.mb-1
                          i.fas.fa-circle.list-bullet.me-2(style='font-size: 0.5rem; color: #333;')
                          | Bonus Value-Adds
                        li.mb-1
                          i.fas.fa-circle.list-bullet.me-2(style='font-size: 0.5rem; color: #333;')
                          | Surge Game Plan
                        li.mb-1
                          i.fas.fa-circle.list-bullet.me-2(style='font-size: 0.5rem; color: #333;')
                          | Discounts Available

                  // Large CTA button with icon
                  .mt-3.schedule-button-container
                    button#cancel-step3-schedule.btn.btn-primary.d-flex.align-items-center(
                      type='button'
                      style='padding: 0.75rem 1.5rem;'
                    )
                      i.fas.fa-calendar-check.me-2
                      | Schedule 1:1 Strategy Meeting

              // ~~~~~~~~~~~~~~~ STEP 4 ~~~~~~~~~~~~~~~~~~
              div#cancel-wizard-step-4.cancellation-step(style='display:none;')
                h3.mb-3 Pricing matters and we hear you. 
                .pick-price-container
                  p.step-text.mb-3
                    | We want SurgeT to be valuable and affordable for firms like yours. If you don't mind sharing, what would feel like a fair monthly price for the value you recieved?
                  form
                    label.form-check-label.d-block
                      input.form-check-input.pricing-feedback(type='radio' name='pricingFeedback' value='$79')
                      | $79 per month per advisor

                    label.form-check-label.d-block
                      input.form-check-input.pricing-feedback(type='radio' name='pricingFeedback' value='$49')
                      | $49 per month per advisor

                    label.form-check-label.d-block
                      input.form-check-input.pricing-feedback(type='radio' name='pricingFeedback' value='Free')
                      | Free

              // ~~~~~~~~~~~~~~~ STEP 5 ~~~~~~~~~~~~~~~~~~
              div#cancel-wizard-step-5.cancellation-step(style='display:none;')
                h3.mb-3 Your success matters to us.
                p.step-text.mb-3
                  | If there's something we could have done differently, we want to know, your input helps shape the future of SurgeTK.
                textarea.form-control#cancelFreeformFeedback(rows='4' placeholder='Additional feedback...')

              // ~~~~~~~~~~~~~~~ STEP 6 ~~~~~~~~~~~~~~~~~~
              div#cancel-wizard-step-6.cancellation-step(style='display:none;')
                h3.mb-3.if-you-cancel If you cancel now, your plan will end on: #[span#final-cancel-end-date {{endDate}}]
                p.step-text.mb-3
                  | After this date you and all your team members will no longer have access to SurgeT. You will no longer have access to saved files like Value-Adds and Advisor Packets or uploaded documents of any kind.

                .form-check.mt-3
                  input.form-check-input#final-cancel-checkbox(type='checkbox')
                  label.form-check-label(for='final-cancel-checkbox')
                    | I understand that if I cancel now, I will lose all data on SurgeTK.

            // MODAL FOOTER (all navigation buttons go here, each step’s set hidden by default)
            .modal-footer

              // STEP 1 FOOTER
              .footer-step1(style='display:none;')
                button#cancel-step1-continue.btn.btn-danger(type='button')
                  | Continue to Cancel
                button#cancel-step1-keepPlan.btn.btn-secondary(type='button' data-bs-dismiss='modal')
                  | Keep My Plan

              // STEP 2 FOOTER
              .footer-step2(style='display:none;')
                button#cancel-step2-back.btn.btn-secondary(type='button')
                  | Back
                button#cancel-step2-next.btn.btn-primary(type='button')
                  | Next

              // STEP 3 FOOTER
              .footer-step3(style='display:none;')
                button#cancel-step3-back.btn.btn-secondary(type='button')
                  | Back

                button#cancel-step3-cancelAnyway.btn.btn-danger(type='button')
                  | No thanks, still cancel

              // STEP 4 FOOTER
              .footer-step4(style='display:none;')
                button#cancel-step4-back.btn.btn-secondary(type='button')
                  | Back
                button#cancel-step4-next.btn.btn-primary(type='button')
                  | Next

              // STEP 5 FOOTER
              .footer-step5(style='display:none;')
                button#cancel-step5-back.btn.btn-secondary(type='button')
                  | Back
                button#cancel-step5-next.btn.btn-primary(type='button')
                  | Next

              // STEP 6 FOOTER
              .footer-step6(style='display:none;')
                button#cancel-step6-back.btn.btn-secondary(type='button')
                  | Back
                button#cancel-confirm-cancel.btn.btn-danger(type='button' disabled=true)
                  | Cancel Pro Plan Now











      div#subscriptionModal.modal.fade(tabindex='-1' aria-hidden='true')
        .modal-dialog.modal-lg.modal-dialog-centered
          .modal-content

            // Modal Header
            .modal-header
              h5.modal-title Upgrade / Change Your Subscription
              button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')

            // STEP INDICATOR (horizontal steps)
            .modal-body.py-0
              .wizard-step-indicator.d-flex.justify-content-between.mb-3
                .wizard-step-indicator-item#indicator-step-1
                  p.wizard-number 1
                  p.wizard-title Choose Plan
                .wizard-step-indicator-item#indicator-step-2
                  p.wizard-number 2
                  p.wizard-title Payment Information
                .wizard-step-indicator-item#indicator-step-3
                  p.wizard-number 3
                  p.wizard-title Review


            // Steps
            // Step 1: Plan & Seats
            div#wizard-step-1(style='display:none; flex-direction:column;')

              // ============================================
              // PLAN SELECTION (similar to onboarding style)
              // ============================================
              .plan-section
                // FREE PLAN
                label.plan-option#modal-plan-free(for='modalPlanFreeRadio' data-plan='free')
                  input#modalPlanFreeRadio(type='radio', name='planChoice', value='free')
                  i.fas.fa-check.free-plan-icon
                  .plan-info
                    .plan-title Free Plan
                    .plan-description $0/month (1 Advisor, 2 Non-Advisors). Limited feature access.

                // PRO PLAN
                label.plan-option#modal-plan-pro(for='modalPlanProRadio' data-plan='pro')
                  input#modalPlanProRadio(type='radio', name='planChoice', value='pro')
                  i.fas.fa-dollar-sign.paid-plan-icon
                  .plan-info
                    .plan-title Purchase Plan - Pro Access
                    .plan-description $95/month per advisor seat. Access to all features.



              // ============================================
              // PAID PLAN DETAILS (hidden if plan == free)
              // We'll REUSE id="modal-seat-count-group" so 
              // your existing JS can show/hide seats & handle 
              // seat count. We also incorporate the monthly vs 
              // annual toggle from the onboarding code, but 
              // keep #monthly-button & #annual-button for the wizard.
              // ============================================
              .paid-plan-details(style='display:none;' id='modal-seat-count-group')
                .card.mt-4.billing-card
                  .card-body

                  

                    // 3) Billing Interval Toggle (keep existing IDs)
                    .d-flex.justify-content-start.align-items-center.mt-4.billing-toggle-container
                      .btn-group.billing-toggle#billing-interval-toggle(role='group' aria-label='Billing Interval')
                        button#monthly-button.btn.btn-outline-teal(type='button' data-interval='monthly') Monthly
                        button#annual-button.btn.btn-outline-teal(type='button' data-interval='annual')
                          | Annual -
                          span.saveTen Save 10%

                    // 4) Advisor Seats & cost
                    .row.mt-4
                      .col-md-6.mb-3.number-advisor-label
                        .advisor-seat-group
                          label.seatcountLabel(for='modal-seat-count') Number of Advisor Seats
                          p.advisor-info Each seat includes 1 Advisor & 2 assistant logins
                        .extra-check-boxes
                          ul.list-unstyled
                            li.d-flex.align-items-center.mb-2
                              i.fas.fa-check.text-success.me-2
                              span Advisor Level Dashboard, see only their AUM & Households
                            li.d-flex.align-items-center.mb-2
                              i.fas.fa-check.text-success.me-2
                              span Ability to Run Value Adds & Surges
                            li.d-flex.align-items-center.mb-2
                              i.fas.fa-check.text-success.me-2
                              span Advisor’s name appears on Value-Adds for their clients

                        .count-money
                          input#modal-seat-count.form-control(type='number', min='1', value='1')
                          .cost-garuntee
                            // If you want a small real-time cost display, 
                            // you can add an ID for JS or simply keep it static:
                            p#modal-pro-price.mb-1 $95/month
                            p.money-back.mt-1 100% money back guarantee*


            // Step 2: Payment Info
            // Step 2: Payment Info
            div#wizard-step-2(style='display:none;')
              // This remains the same:
              p#card-on-file-text

              // Container for the "mock credit card"
              .card-on-file-container
                .mock-credit-card
                  .big-check
                    i.fas.fa-check-circle.me-2.text-success.big-check-icon
                  .card-brand
                    img#card-brand-logo(

                      src='/images/generic.svg'
                      alt='Card Brand Logo'
                      
                    )
                  .card-details
                    .card-number
                      span **** **** **** 
                      span#card-last4 0000
                    .card-holder-name
                      span#card-holder-text Cardholder Name
                    .card-exp
                      | Exp: 
                      span#card-expiration 12/34

              button#edit-payment-method-button.btn.btn-link(type='button')
                i.material-symbols-outlined.me-1 credit_card
                | Edit / Add Payment Method




            
            // Step 3: Review
            div#wizard-step-3(style='display:none;')
              .p-3.rounded

                // Plan name at the top
                p#review-plan-name.font-weight-bold Pro Plan

                // Row: e.g. "Annual          $1140"
                .review-row
                  .review-item-left
                    span#review-billing-interval Annual
                  .review-item-right
                    span#review-cost-per-seat $1140

                // Row: e.g. "Seats            x14"
                .review-row
                  .review-item-left
                    | Seats
                  .review-item-right
                    // Use an "×" if you prefer
                    span.operator.me-2 x
                    span#review-seat-count 14

                // Row: e.g. "=            $15960"
                .review-row
                  .review-item-left
                    | =
                  .review-item-right
                    span#review-subtotal $15960

                // Row: e.g. "+10% Discount"
                // Show/hide this row if using annual discount
                .review-row#discount-line(style='display:none;')
                  .review-item-left
                    | +10% Annual Discount
                  .review-item-right
                    // e.g. "-$1596.00" if you're subtracting from subtotal
                    span#review-discount-amount

                hr.my-2

                // Row: e.g. "Total       $12927.60"
                .review-row.total
                  .review-item-left
                    strong#review-total-label Total
                  .review-item-right
                    span#review-cost $12927.60



            // Modal Footer - Wizard Nav
            .modal-footer
              button#wizard-cancel-button.btn.btn-secondary(type='button', data-bs-dismiss='modal', style='display:none;') Cancel
              button#wizard-prev-button.btn.btn-secondary(type='button', style='display:none;') Back
              button#wizard-next-button.btn.btn-primary(type='button') Next
              button#wizard-confirm-button.btn.btn-primary.loadable-button(type='button', style='display:none;')
                // Normal text inside .button-text
                span.button-text
                  i.material-symbols-outlined.me-1 check_circle
                  | Update Subscription

                // Spinner container
                span.button-spinner-wrapper
                  span.button-spinner.spinner-border.spinner-border-sm(role='status', aria-hidden='true')



      // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      // Update Payment Method Modal
      // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      div#updateCardModal.modal.fade(tabindex='-1' aria-hidden='true')
        .modal-dialog.modal-dialog-centered
          .modal-content
            .modal-header
              h5.modal-title Update Billing Info
              button#close-update-card-modal.btn-close(type='button', aria-label='Close')

            .modal-body
              p.card-p-text Please provide your billing details and card information. This will be used for future charges.

              // Minimal fields:
              // 1) Name on Card
              div.form-group.mb-3
                label(for='card-holder-name') Name on Card
                input.form-control#card-holder-name(type='text' placeholder='Jane Doe')

              // 2) Billing Email
              div.form-group.mb-3
                label(for='card-billing-email') Billing Email
                input.form-control#card-billing-email(type='email' placeholder='jane@example.com')

              // 3) Stripe Element container (card number, expiry, CVC)
              div.form-group.mb-3
                label Card Details
                div#card-element(
                  style='min-height: 100px; border:1px solid #ccc; padding:10px; border-radius:5px;'
                )
                // Display errors
                p#card-errors.text-danger.mt-2

            .modal-footer
              button#cancel-update-card-modal.btn.btn-secondary(type='button') Cancel
              button#save-card-button.btn.btn-primary.loadable-button(type='button')
                // Normal text
                span.button-text Save Card
                // Spinner
                span.button-spinner-wrapper
                  span.button-spinner.spinner-border.spinner-border-sm(role='status', aria-hidden='true')






      // Security Tab Content
      .tab-panel#security
        .tabHeader
          .tabHeaderText
            h2 Security Settings
            p.supportingText Manage your security preferences here.
          .form-actions
            button#security-cancel-button.btn.btn-secondary(type='button', disabled=true) Cancel
            button#security-save-button.btn.btn-primary(type='button', disabled=true) Save Changes

        hr.dividingLine

        // 2FA Section
        .section(data-2fa-enabled=user.is2FAEnabled)
          h3 Two-Factor Authentication (2FA)
          p#twofa-status-text= user.is2FAEnabled ? '2FA is currently enabled on your account.' : '2FA is currently disabled on your account.'

          // Conditionally Render Enable or Disable 2FA Button
          if user.is2FAEnabled
            button#disable2FA-button.btn.btn-danger(type='button') Disable 2FA
          else
            button#enable-2fa-button.btn.btn-primary(type='button') Enable 2FA

          // 2FA Setup Modal

          // 2FA Setup Modal
          div#twofa-modal.modal.fade(tabindex='-1', aria-labelledby='twofaModalLabel', aria-hidden='true')
            div.modal-dialog.modal-dialog-centered
              div.modal-content
                div.modal-header
                  i.lock-icon.material-symbols-outlined lock
                  h5.modal-title#twofaModalLabel Set up two-factor authentication
                  button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')

                div.modal-body
                  p.modal-subtitle#twofaModalSubtitle 2FA is a fantastic way to improve your account security. Use an authenticator app on your mobile device to scan this QR code and enter the verification code below.
                  img#qr-code.img-fluid(src='', alt='QR Code for 2FA') 

                  // Verification Code Input Section
                  div.verification-code
                    input.form-control.code-segment(type='text', maxlength='1', id='code-segment-1')
                    input.form-control.code-segment(type='text', maxlength='1', id='code-segment-2')
                    input.form-control.code-segment(type='text', maxlength='1', id='code-segment-3')
                    span.hyphen - 
                    input.form-control.code-segment(type='text', maxlength='1', id='code-segment-4')
                    input.form-control.code-segment(type='text', maxlength='1', id='code-segment-5')
                    input.form-control.code-segment(type='text', maxlength='1', id='code-segment-6')

                div.modal-footer
                  button#cancel2fa-button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
                  button#verify2FA-button.btn.btn-primary(type='button') Confirm
      


        hr.dividingLine

      
        .section
          h3 Last 10 Sign-In Activities
          table.signin-logs-table
            thead
              tr
                th Timestamp
                th Location
                th Device
            tbody#signin-logs-body
              //- Rows will be populated by JavaScript
      
      
      .tab-panel#team(data-company-id=user.companyId data-firm-id=user.firmId data-is-admin=isAdminAccess)
        .tabHeader
          .tabHeaderText
            h2 Team Members
            p.supportingText View and manage your firm's team members.
            //- p.userRoleTag #{user.role}




          .form-actions
            if isAdminAccess
              button#add-team-member-button.btn.btn-primary(type='button') Add Team Member

        hr.dividingLine

 
        .section
          .seat-usage-tags
            span.badge.bg-info.me-2.advisor-seat-badge Advisor Seats Remaining: 
              span#advisor-seats-remaining 0
            span.badge.bg-info.non-advisor-seat-badge Non-Advisor Seats Remaining:
              span#nonadvisor-seats-remaining 0
          .team-members-table-container
            table.team-members-table.table.table-striped.table-hover
              thead
                tr
                  th.tableHead1.avatar-head 
                  th.tableHead1.email-head Email
                  th.tableHead1.role-head Role
                  th.tableHead1.permissions-head Permissions
                  th.tableHead1.status-head Status
                  th.actions-head Actions
                    
              tbody#team-members-body
                // Rows will be inserted dynamically via teams.js


        hr.dividingLine
        .section.unlinked-advisor-section
          h3 Unlinked Redtail Advisors
          p.supportingText.unlinked-supporting-text.text-muted(style='font-size: 0.9rem;')
            | These are advisors from Redtail who are not yet linked to any Lead Advisor in SurgeTK. 
            | Linking them will update any Households that reference them.

          .table-responsive.unlinked-advisors-table-container
            table.table.table-bordered#unlinked-advisors-table
              thead
                tr
                  th.redtail-advisor-name-cell Redtail Advisor Name
                  th.redtail-type-cell Type
                  th.redtail-link-cell Link to Lead Advisor
                  th.redtail-action-cell Actions
              tbody#unlinked-advisors-body
                // Populated by JavaScript
        hr.dividingLine
    
        .section.unlinked-imported-advisor-section
          h3 Unlinked Imported Advisors
          p.supportingText.unlinked-supporting-text.text-muted(style='font-size: 0.9rem;')
            | These are advisors imported manually who are not yet linked to any Lead Advisor in SurgeTK. Linking them will update any Households that reference them.

          // Use the SAME classes as Redtail’s table
          .table-responsive.unlinked-advisors-table-container
            table.table.table-bordered#unlinked-imported-advisors-table
              thead
                tr
                  // 1) Name column
                  th.redtail-advisor-name-cell Advisor Name
                  // 2) Type column
                  th.redtail-type-cell Type
                  // 3) Link column
                  th.redtail-link-cell Link to Lead Advisor
                  // 4) Actions column
                  th.redtail-action-cell Actions
              tbody#unlinked-imported-advisors-body
                // Populated by JS






  // At bottom of your Pug or near the Add Team Member modal
  div#edit-team-member-modal.modal.fade(tabindex='-1', aria-labelledby='editTeamMemberModalLabel', aria-hidden='true')
    div.modal-dialog.modal-dialog-centered
      div.modal-content
        div.modal-header
          .modal-header-sub-container
            h5.modal-title#editTeamMemberModalLabel Edit Team Member
            p#editUserEmailText.text-muted(style='margin-left:1rem; margin-bottom:0;')
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
        div.modal-body
          form#edit-team-member-form
            input(type='hidden' id='edit-user-id')
            // Updated Edit Modal Fields
            div.form-group
              label(for='edit-role') Role *
              .select-container
                .material-symbols-outlined keyboard_arrow_down
                select#edit-role.form-select(name='role')
                  option(value='' disabled selected) --
                  option(value='admin') Admin
                  option(value='leadAdvisor') Lead Advisor
                  option(value='assistant') Assistant
                  option(value='teamMember') Team Member

            // ADMIN: "Also an Advisor?" checkbox
            div.form-group#editAlsoAdvisorContainer(style='display:none;')
              input#editAlsoAdvisorCheckbox(type='checkbox')
              label(for='editAlsoAdvisorCheckbox') Also an Advisor?

            // LEAD ADVISOR: sub-permission
            div.form-group#edit-leadadvisor-container(style='display:none;')
              label(for='editLeadAdvisorPermissionSelect') Lead Advisor Permission #[span.required *]
              .select-container
                .material-symbols-outlined keyboard_arrow_down
                select#editLeadAdvisorPermissionSelect.form-select
                  option(value='' disabled selected) --
                  option(value='admin') Admin
                  option(value='all') All
                  option(value='limited') Limited
                  option(value='selfOnly') Self Only

              p#editLeadAdvisorPermissionHelp.text-muted

            // ASSISTANT: "assistantToLeadAdvisors" + sub-permission
            div.form-group#edit-assistant-to-dropdown-container(style='display:none;')
              label(for='editAssistantLeadAdvisorDisplayInput') Assistant to which Lead Advisor(s)?

              .dropdown#editAssistantLeadAdvisorDropdown
                .select-container
                  i.material-symbols-outlined.dropdown-arrow-icon keyboard_arrow_down
                  input.form-control(
                    type='text'
                    id='editAssistantLeadAdvisorDisplayInput'
                    placeholder='Select one or more lead advisors...'
                    data-bs-toggle='dropdown'
                    data-bs-auto-close='outside'
                    aria-expanded='false'
                    readonly
                    style='cursor: pointer;'
                  )
                  input#editAssistantLeadAdvisorHiddenInput(type='hidden' name='assistantToLeadAdvisors')

                  .dropdown-menu#editAssistantLeadAdvisorDropdownMenu( aria-labelledby='editAssistantLeadAdvisorDisplayInput' )

            // Assistant Permission
            div.form-group#edit-assistant-permission-container(style='display:none;')
              label(for='editAssistantPermissionSelect') Assistant Permission #[span.required *]
              .select-container
                .material-symbols-outlined keyboard_arrow_down
                select#editAssistantPermissionSelect.form-select
                  option(value='' disabled selected) --
                  option(value='admin') Admin
                  option(value='inherit') Inherit Advisor’s Permissions
              p#editAssistantPermissionHelp.text-muted

            // TEAM MEMBER: sub-permission
            div.form-group#edit-team-member-permission-container(style='display:none;')
              label(for='editTeamMemberPermissionSelect') Team Member Permission #[span.required *]
              .select-container
                .material-symbols-outlined keyboard_arrow_down
                select#editTeamMemberPermissionSelect.form-select
                  option(value='' disabled selected) --
                  option(value='admin') Admin
                  option(value='viewEdit') View/Edit Households
                  option(value='viewOnly') View Only: All

             

        div.modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
          button#edit-submit.btn.btn-primary(type='submit' form='edit-team-member-form') Save Changes



  if isAdminAccess
    div#add-team-member-modal.modal.fade(tabindex='-1', aria-labelledby='addTeamMemberModalLabel', aria-hidden='true')
      div.modal-dialog.modal-dialog-centered
        div.modal-content
          div.modal-header
            h5.modal-title#addTeamMemberModalLabel Invite a New Team Member
            button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Close')
          div.modal-body
            form#add-team-member-form
              // 1) Email
              div.form-group
                label(for='invite-email') Email Address #[span.required *]
                input#invite-email.form-control(type='email')

              // 2) Role
              div.form-group
                label(for='invite-role') Role #[span.required *]
                .select-container
                  .material-symbols-outlined keyboard_arrow_down
                  select#invite-role.form-select(name='role')
                    option(value='' disabled selected) --
                    option(value='admin') Admin
                    option(value='leadAdvisor') Lead Advisor
                    option(value='assistant') Assistant
                    option(value='teamMember') Team Member

              // ADMIN: "Also an Advisor?" checkbox
              div.form-group#also-advisor-container(style='display:none;')
                input#also-advisor-checkbox(type='checkbox')
                label(for='also-advisor-checkbox') Also an Advisor?

              // LEAD ADVISOR: sub-permission dropdown
              div.form-group#lead-advisor-permission-container(style='display:none;')
                label(for='leadAdvisorPermissionSelect') Lead Advisor Permission #[span.required *]
                .select-container
                  .material-symbols-outlined keyboard_arrow_down
                  select#leadAdvisorPermissionSelect.form-select
                    option(value='' disabled selected) --
                    option(value='admin') Admin
                    option(value='all') All
                    option(value='limited') Limited
                    option(value='selfOnly') Self Only
                  // Helper text
                p#leadAdvisorPermissionHelp.text-muted

              // ASSISTANT: "assistantToLeadAdvisors" multi-check + sub-permission
              // Assistant Dropdown Container
              div.form-group#assistant-to-dropdown-container(style='display:none;')
                label(for='assistantLeadAdvisorDisplayInput') Assistant to which Lead Advisor(s)? #[span.required *]

                // Wrapper that becomes the actual dropdown
                .dropdown#assistantLeadAdvisorDropdown

                  .select-container
                    i.material-symbols-outlined.dropdown-arrow-icon keyboard_arrow_down


                    // (A) The visible text input
                    input.form-control(
                      type='text'
                      id='assistantLeadAdvisorDisplayInput'
                      placeholder='Select one or more lead advisors...'
                      data-bs-toggle='dropdown'
                      data-bs-auto-close='outside'
                      aria-expanded='false'
                      readonly
                      style='cursor: pointer;'
                    )

                    // (B) A hidden input that actually holds the array of IDs for your server
                    input#assistantLeadAdvisorHiddenInput(type='hidden' name='assistantToLeadAdvisors')

                    // (C) The dropdown-menu that contains the checkboxes
                    .dropdown-menu#assistantLeadAdvisorDropdownMenu(
                      aria-labelledby='assistantLeadAdvisorDisplayInput'
                    )
                      // We'll dynamically populate each lead advisor as a checkbox
                      // Example static fallback:
                      label.dropdown-item.form-check-label
                        input.form-check-input(type='checkbox' class='assistantLeadAdvisorCheckbox' value='12345')
                        | John Advisor
                      label.dropdown-item.form-check-label
                        input.form-check-input(type='checkbox' class='assistantLeadAdvisorCheckbox' value='23456')
                        | Jane Advisor



              // Optionally, show the "Assistant Permission" fields after this, etc.
              div.form-group#assistant-permission-container(style='display:none;')
                label(for='assistantPermissionSelect') Assistant Permission #[span.required *]
                .select-container
                  .material-symbols-outlined keyboard_arrow_down
                  select#assistantPermissionSelect.form-select
                    option(value='' disabled selected) --
                    option(value='admin') Admin
                    option(value='inherit') Inherit Advisor’s Permissions

                p#assistantPermissionHelp.text-muted


              // TEAM MEMBER: sub-permission
              div.form-group#team-member-permission-container(style='display:none;')
                label(for='teamMemberPermissionSelect') Team Member Permission #[span.required *]
                .select-container
                  .material-symbols-outlined keyboard_arrow_down
                  select#teamMemberPermissionSelect.form-select
                    option(value='' disabled selected) --
                    option(value='admin') Admin
                    option(value='viewEdit') View/Edit Households
                    option(value='viewOnly') View Only: All
                p#teamMemberPermissionHelp.text-muted

             

  

          div.modal-footer
            button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancel
            button#invite-submit.btn.btn-primary(type='submit', form='add-team-member-form') Invite

  // Confirmation Modal for Removing a Team Member
  div#confirmRemoveModal.modal.fade(tabindex='-1' aria-hidden='true')
    div.modal-dialog.modal-dialog-centered
      div.modal-content
        div.modal-header
          h5.modal-title Confirm Removal
          button.btn-close(type='button' data-bs-dismiss='modal' aria-label='Close')
        div.modal-body
          // We'll dynamically insert the email or message via JS
          p#confirmRemoveMessage Are you sure you want to remove this member?
        div.modal-footer
          button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Cancel
          button#confirmRemoveBtn.btn.btn-danger(type='button') Remove


block scripts
  script.
    window.IS_ADMIN_ACCESS = !{isAdminAccess};
  script(src="https://js.stripe.com/v3")
  script.
    window.STRIPE_PUBLIC_KEY = "#{process.env.STRIPE_PUBLIC_KEY}"; 
    window.PRO_COST_PER_SEAT = "#{process.env.PRO_COST_PER_SEAT}";
    window.myUser = !{JSON.stringify(user)};

   


  script(src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js', integrity='sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz', crossorigin='anonymous')
  script(src='https://unpkg.com/@simonwep/pickr/dist/pickr.min.js')
  script(src='/socket.io/socket.io.js')
  script(src='/js/appScript.js')
  script(src='/js/settings.js')
  script(src='/js/teams.js')
  script(src='/js/headerDropdownFilter.js')
  script(src="/js/loading.js")
  script(src='/js/billing.js')
  script(src='/js/cancelSubscriptionFlow.js')

